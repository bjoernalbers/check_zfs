#!/usr/bin/env ruby -w
require 'nagios-probe'

class CheckZFS < Nagios::Probe
  def zpool_list
    @zpool_list ||= `zpool list -H -o name,health`
  end
  
  def check_crit
    !zpool_list.split("\n").delete_if {|p| p =~ /(ONLINE|DEGRADED)/ }.empty?
  end

  def check_warn
    zpool_list.include?('DEGRADED')
  end

  def crit_message
    "1 pool is busted"
  end

  def warn_message
    "1 pool is degraded"
  end
  
  def ok_message
    "All pools are online"
  end
end

begin
  options = {} # Nagios::Probe constructor accepts a single optional param that is assigned to @opts
  probe = CheckZFS.new(options)
  probe.run
rescue Exception => e
  puts "Unknown: " + e
  exit Nagios::UNKNOWN
end

puts probe.message
exit probe.retval
